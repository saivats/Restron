<!DOCTYPE html>
<html>
<head>
    <title>Restron Owner</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; padding: 20px; background-color: #f4f4f9; }
        .grid { display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; }

        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); flex: 1; min-width: 250px; }
        .card h2 { margin-top: 0; color: #333; border-bottom: 2px solid #ff5722; padding-bottom: 10px; display: inline-block; font-size: 1.2em; }

        .number { display: block; font-size: 2em; font-weight: bold; color: #ff5722; }
        .label { color: #777; font-size: 0.8em; text-transform: uppercase; font-weight: 600; }

        .list-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee; }

        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { text-align: left; padding: 10px; border-bottom: 1px solid #eee; font-size: 0.9em; }
        th { background: #f8f8f8; color: #555; }

        /* Tags for Order Log */
        .tag { padding: 4px 8px; border-radius: 4px; font-weight: bold; font-size: 0.8em; }
        .tag-dine { background: #e3f2fd; color: #1565c0; }
        .tag-del { background: #fff3e0; color: #ef6c00; }

        input, select { padding: 10px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 5px; }
        button { padding: 10px; background: #333; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button.green { background: #28a745; width: 100%; }
        button.red { background: #dc3545; width: 100%; }
    </style>
</head>
<body>
    <h1>üëë Owner Dashboard</h1>

    <div class="grid">
        <div class="card">
            <span class="number" id="rev-today">‚Çπ0</span>
            <span class="label">Today</span>
        </div>
        <div class="card">
            <span class="number" id="rev-week">‚Çπ0</span>
            <span class="label">Week</span>
        </div>
        <div class="card">
            <span class="number" id="rev-month">‚Çπ0</span>
            <span class="label">Month</span>
        </div>
    </div>

    <div class="grid">
        <div class="card">
            <h2>üìä Performance</h2>
            <div class="list-row"><span>Lifetime Revenue</span> <b id="metric-total" style="color:#28a745;">‚Çπ0</b></div>
            <div class="list-row"><span>Avg Order (AOV)</span> <b id="metric-aov">‚Çπ0</b></div>
            <div class="list-row"><span>Peak Hour</span> <b id="metric-peak">--</b></div>
        </div>
        <div class="card">
            <h2>üî• Best Sellers (Month)</h2>
            <div id="best-sellers-month">Loading...</div>
        </div>
    </div>

    <div class="grid">
        <div class="card" style="flex: 2;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h2>üìÖ Master History Report</h2>
                <div>
                    <select id="search-type" onchange="toggleInput()">
                        <option value="date">By Date (Detailed)</option>
                        <option value="month">By Month (Summary)</option>
                    </select>
                    <input type="date" id="hist-date">
                    <input type="month" id="hist-month" style="display:none;">
                    <button onclick="getHistory()">Get Report</button>
                </div>
            </div>

            <div id="hist-result" style="display:none; margin-top:20px;">
                <div style="display:flex; gap:20px; padding:15px; background:#f1f1f1; border-radius:5px; font-weight:bold; margin-bottom:20px;">
                    <span>üí∞ Revenue: <span id="h-rev" style="color:#28a745;">0</span></span>
                    <span>ü•¨ Veg Sold: <span id="h-veg">0</span></span>
                    <span>üçó Non-Veg Sold: <span id="h-non">0</span></span>
                </div>

                <div id="log-container" style="display:none;">
                    <h3>üìù Full Order Log (A-Z)</h3>
                    <div style="max-height: 400px; overflow-y: auto;">
                        <table id="log-table">
                            <thead><tr><th>ID</th><th>Time</th><th>Type</th><th>Table</th><th>Items Ordered</th><th>Bill</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

                <h3 style="margin-top:20px;">üì¶ Item Summary</h3>
                <div style="max-height: 200px; overflow-y: auto;">
                    <table id="h-table">
                        <thead><tr><th>Item Name</th><th>Qty Sold</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="grid">
        <div class="card">
            <h2>üõí Shopping List</h2>
            <div id="inv-list">Loading...</div>
            <button onclick="clearList()" class="red" style="margin-top:10px;">Clear List</button>
        </div>
        <div class="card">
            <h2>‚ûï Add Dish</h2>
            <input id="name" placeholder="Name" style="width:100%;">
            <input id="price" placeholder="Price" style="width:100%;">
            <input id="cat" placeholder="Category" style="width:100%;">
            <button onclick="addItem()" class="green" style="margin-top:5px;">Add to Menu</button>
        </div>
    </div>

    <script>
        function toggleInput() {
            const type = document.getElementById('search-type').value;
            document.getElementById('hist-date').style.display = (type === 'date') ? 'inline-block' : 'none';
            document.getElementById('hist-month').style.display = (type === 'month') ? 'inline-block' : 'none';
        }

        async function loadData() {
            const res = await fetch('/owner/analytics/');
            const data = await res.json();

            document.getElementById('rev-today').innerText = "‚Çπ" + data.revenue.today;
            document.getElementById('rev-week').innerText = "‚Çπ" + data.revenue.week;
            document.getElementById('rev-month').innerText = "‚Çπ" + data.revenue.month;
            document.getElementById('metric-total').innerText = "‚Çπ" + data.revenue.total;
            document.getElementById('metric-aov').innerText = "‚Çπ" + data.advanced.aov;

            if(data.advanced.peak_hours.length > 0) {
                const h = data.advanced.peak_hours[0].hour;
                const ampm = h >= 12 ? 'PM' : 'AM';
                const h12 = h % 12 || 12;
                document.getElementById('metric-peak').innerText = `${h12} ${ampm}`;
            }

            const bsDiv = document.getElementById('best-sellers-month');
            bsDiv.innerHTML = '';
            data.best_sellers_month.forEach((item, i) => {
                bsDiv.innerHTML += `<div class="list-row"><span>#${i+1} ${item.name}</span><b>${item.qty}</b></div>`;
            });

            const invRes = await fetch('/inventory/');
            const inv = await invRes.json();
            const invList = document.getElementById('inv-list');
            invList.innerHTML = inv.length ? '' : '<p style="color:#aaa;">No requests.</p>';
            inv.forEach(i => invList.innerHTML += `<div class="list-row"><span>${i.item_name}</span></div>`);
        }

        async function getHistory() {
            const type = document.getElementById('search-type').value;
            const val = document.getElementById(type === 'date' ? 'hist-date' : 'hist-month').value;
            if(!val) return alert("Select a date!");

            const res = await fetch(`/owner/history/?${type}=${val}`);
            const data = await res.json();

            document.getElementById('hist-result').style.display = 'block';
            document.getElementById('h-rev').innerText = "‚Çπ" + data.revenue;
            document.getElementById('h-veg').innerText = data.veg_sold;
            document.getElementById('h-non').innerText = data.non_veg_sold;

            // 1. Fill Item Summary (Always visible)
            const sumBody = document.querySelector('#h-table tbody');
            sumBody.innerHTML = '';
            if(data.items.length === 0) sumBody.innerHTML = "<tr><td colspan='2'>No sales.</td></tr>";
            else data.items.forEach(i => sumBody.innerHTML += `<tr><td>${i.name}</td><td>${i.qty}</td></tr>`);

            // 2. Fill Detailed Log (Only for Date search)
            const logContainer = document.getElementById('log-container');
            if (type === 'date' && data.detailed_logs) {
                logContainer.style.display = 'block';
                const logBody = document.querySelector('#log-table tbody');
                logBody.innerHTML = '';

                if(data.detailed_logs.length === 0) {
                    logBody.innerHTML = "<tr><td colspan='6'>No orders found for this day.</td></tr>";
                } else {
                    data.detailed_logs.forEach(order => {
                        const typeTag = order.type === 'Delivery'
                            ? `<span class="tag tag-del">üõµ DELIVERY</span>`
                            : `<span class="tag tag-dine">üçΩÔ∏è DINE-IN</span>`;

                        logBody.innerHTML += `
                            <tr>
                                <td>#${order.id}</td>
                                <td>${order.time}</td>
                                <td>${typeTag}</td>
                                <td>${order.table}</td>
                                <td style="color:#555; font-size:0.85em;">${order.items}</td>
                                <td><b>‚Çπ${order.total}</b></td>
                            </tr>
                        `;
                    });
                }
            } else {
                logContainer.style.display = 'none';
            }
        }

        async function addItem() {
            const name = document.getElementById('name').value;
            const price = document.getElementById('price').value;
            const cat = document.getElementById('cat').value;
            if(name && price) {
                await fetch(`/menu/?name=${name}&price=${price}&category=${cat || 'General'}`, { method: 'POST' });
                alert("Added!"); loadData();
            }
        }

        async function clearList() {
            await fetch('/inventory/', { method: 'DELETE' });
            loadData();
        }

        loadData();
    </script>
</body>
</html>